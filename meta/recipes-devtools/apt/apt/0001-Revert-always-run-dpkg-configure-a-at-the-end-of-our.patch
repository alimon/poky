From 54061afa664a8d7c3e5c9c7eafd407b046237c18 Mon Sep 17 00:00:00 2001
From: Roy Li <rongqing.li@windriver.com>
Date: Fri, 22 May 2015 08:05:15 +0800
Subject: [PATCH] Revert "always run 'dpkg --configure -a' at the end of our
 dpkg callings"
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Upstream-Status: Inappropriate [embedded specific]

This reverts commit a2a75ff4516f7609f4c55b42270abb8d08943c60, which
always run 'dpkg --configure -a' at the end of our dpkg callings,
but it does not work for cross-compile, since the rootfs dir can not
be passed into dpkg, and lead to the below similar error:
   -------
   |mkdir: cannot create directory '/usr/lib/opkg': Permission denied
   -------

Signed-off-by: Roy Li <rongqing.li@windriver.com>
Signed-off-by: Aníbal Limón <anibal.limon@linaro.org>
---
 apt-pkg/deb/dpkgpm.cc                              |  9 ++-------
 test/integration/test-apt-progress-fd-deb822       | 14 +++++++-------
 .../test-no-fds-leaked-to-maintainer-scripts       |  4 +---
 3 files changed, 10 insertions(+), 17 deletions(-)

diff --git a/apt-pkg/deb/dpkgpm.cc b/apt-pkg/deb/dpkgpm.cc
index 0778f217a..8c092a4d5 100644
--- a/apt-pkg/deb/dpkgpm.cc
+++ b/apt-pkg/deb/dpkgpm.cc
@@ -1203,12 +1203,6 @@ void pkgDPkgPM::BuildPackagesProgressMap()
 	 }
       }
    }
-   /* one extra: We don't want the progress bar to reach 100%, especially not
-      if we call dpkg --configure --pending and process a bunch of triggers
-      while showing 100%. Also, spindown takes a while, so never reaching 100%
-      is way more correct than reaching 100% while still doing stuff even if
-      doing it this way is slightly bending the rules */
-   ++PackagesTotal;
 }
                                                                         /*}}}*/
 bool pkgDPkgPM::Go(int StatusFd)					/*{{{*/
@@ -1689,7 +1683,8 @@ bool pkgDPkgPM::Go(APT::Progress::PackageManager *progress)
 
       // support subpressing of triggers processing for special
       // cases like d-i that runs the triggers handling manually
-      if (_config->FindB("DPkg::ConfigurePending", true))
+      bool const SmartConf = (_config->Find("PackageManager::Configure", "all") != "all");
+      if (_config->FindB("DPkg::ConfigurePending", SmartConf) == true)
 	 List.emplace_back(Item::ConfigurePending, pkgCache::PkgIterator());
    }
    bool const TriggersPending = _config->FindB("DPkg::TriggersPending", false);
diff --git a/test/integration/test-apt-progress-fd-deb822 b/test/integration/test-apt-progress-fd-deb822
index d9a4505d1..b5d45f7b8 100755
--- a/test/integration/test-apt-progress-fd-deb822
+++ b/test/integration/test-apt-progress-fd-deb822
@@ -27,36 +27,36 @@ Message: Installing testing (amd64)
 
 Status: progress
 Package: testing:amd64
-Percent: 16.6667
+Percent: 20
 Message: Preparing testing (amd64)
 
 Status: progress
 Package: testing:amd64
-Percent: 33.3333
+Percent: 40
 Message: Unpacking testing (amd64)
 
 Status: progress
 Package: testing:amd64
-Percent: 50.0000
+Percent: 60.0000
 Message: Preparing to configure testing (amd64)
 
 Status: progress
-Percent: 50.0000
+Percent: 60.0000
 Message: Running dpkg
 
 Status: progress
 Package: testing:amd64
-Percent: 50.0000
+Percent: 60.0000
 Message: Configuring testing (amd64)
 
 Status: progress
 Package: testing:amd64
-Percent: 66.6667
+Percent: 80
 Message: Configuring testing (amd64)
 
 Status: progress
 Package: testing:amd64
-Percent: 83.3333
+Percent: 100
 Message: Installed testing (amd64)
 '
 
diff --git a/test/integration/test-no-fds-leaked-to-maintainer-scripts b/test/integration/test-no-fds-leaked-to-maintainer-scripts
index 747af69ff..da24d2ff5 100755
--- a/test/integration/test-no-fds-leaked-to-maintainer-scripts
+++ b/test/integration/test-no-fds-leaked-to-maintainer-scripts
@@ -112,11 +112,9 @@ status config-files $PKGNAME 1.0
 status config-files $PKGNAME 1.0
 status config-files $PKGNAME 1.0
 status config-files $PKGNAME 1.0
-status not-installed $PKGNAME <none>
-startup packages configure" cut -f 3- -d' ' rootdir/var/log/dpkg.log
+status not-installed $PKGNAME <none>" cut -f 3- -d' ' rootdir/var/log/dpkg.log
 	fi
 	testequalor2 "dpkg-query: no packages found matching ${PKGNAME}" "No packages found matching ${PKGNAME}." dpkg -l "$PKGNAME"
-}
 checkpurge
 
 msgtest 'setsid provided is new enough to support' '-w'
-- 
2.19.2

